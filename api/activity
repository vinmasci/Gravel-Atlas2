const Activity = require('../models/Activity');

// Because we're using Auth0's SPA SDK, we'll verify the token manually
async function verifyAuth0Token(req) {
    try {
        const token = req.headers.authorization?.replace('Bearer ', '');
        if (!token) return null;

        // Extract user info from token - this will be available in API headers
        // from the Auth0 SPA SDK
        const auth0Id = req.headers['x-user-sub'];
        if (!auth0Id) return null;

        return { sub: auth0Id };
    } catch (error) {
        console.error('Error verifying token:', error);
        return null;
    }
}

export default async function handler(req, res) {
    if (req.method === 'GET') {
        try {
            const page = parseInt(req.query.page) || 1;
            const limit = parseInt(req.query.limit) || 20;
            const type = req.query.type;

            const query = {};
            if (type) query.type = type;

            const [activities, total] = await Promise.all([
                Activity.find(query)
                    .sort({ createdAt: -1 })
                    .skip((page - 1) * limit)
                    .limit(limit)
                    .lean(),
                Activity.countDocuments(query)
            ]);

            return res.status(200).json({
                activities,
                pagination: {
                    current: page,
                    pages: Math.ceil(total / limit),
                    hasMore: page * limit < total
                }
            });
        } catch (error) {
            console.error('Error fetching activities:', error);
            return res.status(500).json({ error: 'Failed to fetch activities' });
        }
    } 
    
    if (req.method === 'POST') {
        try {
            const user = await verifyAuth0Token(req);
            if (!user) {
                return res.status(401).json({ error: 'Not authenticated' });
            }

            const { type, action, metadata } = req.body;
            
            const activity = new Activity({
                auth0Id: user.sub,
                type,
                action,
                metadata,
                createdAt: new Date()
            });

            await activity.save();
            return res.status(201).json(activity);
        } catch (error) {
            console.error('Error creating activity:', error);
            return res.status(500).json({ error: 'Failed to create activity' });
        }
    }

    // Handle unsupported methods
    res.setHeader('Allow', ['GET', 'POST']);
    return res.status(405).json({ error: `Method ${req.method} Not Allowed` });
}